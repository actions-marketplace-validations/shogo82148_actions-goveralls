name: "test"
on:
  pull_request:
  push:
    branches:
      - master
      - 'releases/*'

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
        go:
          - '1.4'  # minimum version that actions/setup-go supports
          - '1.10' # last version that doesn't support go modules
          - '1.11' # first version that supports go modules
          - '1.x'  # latest version
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2

      - name: Set up Go
        uses: actions/setup-go@v1
        with:
          go-version: '1.13.5'
      - run: go version

      - name: Set up the action
        run: |
          make all # build goveralls binaries
          npm ci        # install node modules
          npm run build # build JavaScript
      - run: npm test

      - name: Set up Go ${{ matrix.go }}
        uses: actions/setup-go@v1
        with:
          go-version: ${{ matrix.go }}
      - run: go version

      - uses: actions/checkout@v2
        with:
          path: src/github.com/shogo82148/actions-goveralls
      - run: git fetch --depth=1 origin $GITHUB_HEAD_REF
        working-directory: src/github.com/shogo82148/actions-goveralls
      - run: go test -v -coverprofile=profile.cov ./...
        env:
          GO111MODULE: "on"
          GOPATH: ${{ github.workspace }}
        shell: bash
        working-directory: src/github.com/shogo82148/actions-goveralls
      - name: send coverage
        uses: ./
        with:
          path-to-profile: src/github.com/shogo82148/actions-goveralls/profile.cov
          parallel: true

  finish:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Go
        uses: actions/setup-go@v1
        with:
          go-version: "1.x"
      - name: Set up the action
        run: |
          make all      # build goveralls binaries
          npm ci        # install node modules
          npm run build # build JavaScript
      - name: finalize parallel build
        uses: ./
        with: 
          parallel-finished: true
